{% extends 'base/base.html' %}
{% load static %}
{% block title %}
Page3 - Community
{% endblock title %}

{% block content %}
{% include 'navigation/navbar-top.html' %}
{% include 'community/community_header.html' %}

<div class="main-body">
    {% include 'navigation/sidebar-left.html' %}


    <div class="page-contents user-profile-page-contents">
        <div class="posts-timeline">
            {% include 'user/user_profile_info_holder.html' %}



            <div class="profile-stats">
                <div class="logged_in_user">{{user.username}}</div>
                <div class="user_page_profile_pic"><img src="/media/{{profile.profile_pic}}" /></div>
                <h1>This is the profilepage of</h1>
                <h1 class="user_name">{{profile_owner.username}}</h1>
                <div class="followers">Followers{{profile.followers.count}}</div>
                <div class="followers">Following{{profile.following.count}}</div>


                {%for g in gamer_profiles%}

                {% if g.game == main_game_profile.main_gamer_profile.game %}

                <div class="main_game" style="display: none;">{{g.game}}</div>



                {%endif%}
                {%endfor%}
                <div class="main_game-specific-stats">
                    {%for g in gamer_profiles%}
                    {% if g.game == main_game_profile.main_gamer_profile.game %}
                    <button id="main_gamer_profiles-btn">
                        <div>
                            {%for logo, url in game_logos.items%}
                            {%if g.game == logo %}
                            <img class="main_gamer_profiles-btn-img" src={{url}} alt="">
                            {%endif%}
                            {%endfor%}
                            <div class="main_gamer_profiles-btn-value">
                                {{g.game}}
                            </div>
                        </div>
                    </button>

                    {%endif%}
                    {%endfor%}

                </div>
                <div class="main_gamer_profiles_dropdown-container">
                    <div class="main_gamer_profiles_dropdown">
                        {%for g in gamer_profiles%}
                        <button class="main_gamer_profiles_dropdown-btn">

                            {%for logo, url in game_logos.items%}
                            {%if g.game == logo %}

                            <img src="{{url}}">

                            {%endif%}
                            {%endfor%}
                            <div class="main_gamer_profiles_dropdown-item">{{g.game}}</div>


                        </button>

                        {%endfor%}
                    </div>
                </div>
                <div class="main_gamer_profile_stats_section">

                </div>
                <button class="follow_btn">Follow</button>
            </div>

        </div>

        {% include 'navigation/sidebar_user_profile.html' %}
    </div>
</div>

<script src="{% static 'PostIT/js/jquery.waypoints.min.js' %}"></script>
<script src="{% static 'PostIT/js/infinite.min.js'%}"></script>




<script>
    function playPauseVideo() {
        let videos = document.querySelectorAll("video");
        console.log("VIDEOS" + videos)
        videos.forEach((video) => {
            // We can only control playback without insteraction if video is mute
            video.muted = true;
            // Play is a promise so we need to check we have it
            let playPromise = video.play();
            if (playPromise !== undefined) {
                playPromise.then((_) => {
                    let observer = new IntersectionObserver(
                        (entries) => {
                            entries.forEach((entry) => {
                                if (
                                    entry.intersectionRatio !== 1 &&
                                    !video.paused
                                ) {
                                    video.pause();
                                } else if (video.paused) {
                                    video.play();
                                }
                            });
                        },
                        { threshold: 0.9 }
                    );
                    observer.observe(video);
                });
            }
        });
    }
</script>

<script>
    $(document).ready(function () {

        $('.profile-info-stats').addClass('selected-tab');

        $('.follow_btn').click(function () {
            $.ajax({
                type: 'POST',
                url: `/start_following/${$('.user_name').text()}`,
                data: {
                    'user': $('.logged_in_user').text(),
                    // csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success: function (response) {

                },
                error: function (response) {
                    //alert("Error getting ranks and servers")
                }
            })
        })
    })


    var selected_gamer_profile;
    $('.main_gamer_profiles_dropdown-container').css('display', 'none');
    $(document).ready(function () {
        document.getElementById("main_gamer_profiles-btn").addEventListener("click", Toggle_Main_Dropdown_Display);
        selected_gamer_profile = $('.main_game').text();
        get_selected_game_stats();
        Toggle_Main_Dropdown_Display();
    });

    $('.main_gamer_profiles_dropdown-btn').click(function () {
        selected_gamer_profile = $(this).text().trim();
        console.log(selected_gamer_profile);
        get_selected_game_stats();
    });

    function get_selected_game_stats() {
        user_name = $('.user_name').text().replaceAll(' ', '');
        $.ajax({
            type: 'POST',
            url: `/get_user_profile_stats/${user_name}/${selected_gamer_profile}`,


            dataType: "json",
            data: {
                game: selected_gamer_profile,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function (response) {

                $('.main_gamer_profile_stats_section').html(response['gamer_profile_stats']);
                Toggle_Main_Dropdown_Display();
                console.log(response['game_logo'])
                $('.main_gamer_profiles-btn-value').text(selected_gamer_profile);
                $('.main_gamer_profiles-btn-img').attr("src", response['game_logo']);

            }
        })
    }


    function Toggle_Main_Dropdown_Display() {
        if ($('.main_gamer_profiles_dropdown-container').css('display') == 'flex') {
            $('.main_gamer_profiles_dropdown-container').css('display', 'none');
        }
        else $('.main_gamer_profiles_dropdown-container').css('display', 'flex');
    }
</script>



<script src="{% static 'PostIT/js/togglePostOptions.js'%}"></script>
{% endblock content %}