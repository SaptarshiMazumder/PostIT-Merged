{% extends 'base/base.html' %}
{% load static %}
{% block title %}
Create Gamer Profile
{% endblock title %}

{% block content %}
{% include 'navigation/navbar-top.html' %}
{% load crispy_forms_tags %}
{% if user.is_authenticated %}
<div class="main-body">
    {% include 'navigation/sidebar-left.html' %}
    <div class="page-contents">
        <div class="posts-timeline">
            <div class="post">
                <form action="" method="POST" enctype="multipart/form-data" id="gamerprofile_form">

                    <div class="gamer_profile_form">
                        <div class="header">
                            Edit Gamer Profile
                        </div>
                        <hr>
                        {% csrf_token %}

                        <div class="profile-item">
                            <div class="label">Game Title</div>
                            <!-- <div class="game">{{form.game}}</div> -->
                            <select name="game_to_edit" id="game_to_edit" class="game_to_edit">
                                {%for g in gamer_profiles%}
                                <option value={{g.game}}>{{g.game}}</option>
                                {%endfor%}
                            </select>
                        </div>
                        <div class="profile-item">
                            <div class="label"> Preferred Server</div>
                            <select class="servers" form="gamerprofile_form"></select>
                        </div>
                        <div class="profile-item">
                            <div class="label"> Current Rank</div>
                            <select class="ranks" form="gamerprofile-form">Enter current rank</select>
                        </div>
                        <div class="profile-item">
                            <div class="label">Additional Fields</div>
                            <div class="additional-fields">

                            </div>
                        </div>
                        <div class="profile-item">
                            <input type="checkbox" id="is_main" name="is_main">
                            <label for="is_main" class="label"> Is this your main gamer profile</label>

                        </div>
                        <button type="submit" name="submit-btn">Save Profile</button>

                    </div>
                </form>

                <input type="checkbox" name="is_post" id="is_post">Post it for your followers to see!
                <div class="post_form">
                    <input type="text" name="post_body" id="post_body">
                </div>
            </div>
        </div>
        <div class="sidebar">

            {% include 'gamerProfile/gamer_profile_page_sidebar.html' %}
        </div>
    </div>
</div>
<!-- <form  action="" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        
        
    </form> -->

{% else %}
Login first!
{% endif %}

<script src="{% static 'PostIT/js/jquery.waypoints.min.js' %}"></script>
<script src="{% static 'PostIT/js/infinite.min.js'%}"></script>

<script>
    var pref_game = "";
    $(document).ready(function () {
        pref_game = $('.game_to_edit').find(":selected").text();
        get_saved_game_profile_data();
    });

    $(".post_form").hide();
    $("#is_post").click(function () {
        if ($(this).is(":checked")) {
            $(".post_form").show();
        }
        else {
            $(".post_form").hide();
        }
    })
    $('select.game_to_edit').change(function () {
        pref_game = $(this).children("option:selected").text();
        get_saved_game_profile_data();


    })

    function get_saved_game_profile_data() {
        $.ajax({
            type: 'GET',
            url: `/get_saved_gamerank_server/${pref_game}`,
            success: function (response) {
                console.log(response['saved_rank']);

                $('.servers').empty();
                for (let i = 0; i < response['servers'].length; i++) {
                    if (response['servers'][i][0] == response['saved_server'])
                        $('.servers').append(`<option selected="selected">${response['servers'][i][0]}</option>`)
                    else
                        $('.servers').append(`<option>${response['servers'][i][0]}</option>`)

                }

                $('.ranks').empty();
                for (let i = 0; i < response['ranks'].length; i++) {
                    if (response['ranks'][i][0] == response['saved_rank'])
                        $('.ranks').append(`<option selected="selected">${response['ranks'][i][0]}</option>`)
                    else
                        $('.ranks').append(`<option>${response['ranks'][i][0]}</option>`)
                }

                $('.additional-fields').empty();
                for (let i = 0; i < response['additional_fields'].length; i++) {

                    let field = response['additional_fields'][i]

                    $('.additional-fields').append(`<div> ${response['additional_fields'][i]}</div>
                                                    <input name=field_${i} class=field_${i}></input>`);
                    $(`.field_${i}`).val(response['additional_fields'][i]);
                }
                console.log(response['additional_fields'][1]);
            }
        })
    }
    let is_main = false;
    $('#is_main').click(function () {

        if ($(this).is(":checked")) {
            is_main = true;
        }
        else is_main = false;
        console.log(is_main);
    })

    $(document).on('submit', '#gamerprofile_form', function (e) {
        e.preventDefault();

        var user_name = $('#currentuser').text();
        console.log(user_name, pref_game);
        $.ajax({
            type: 'POST',
            url: `/create_gamer_profile/${user_name}`,
            data: {
                game: pref_game,
                rank: $('.ranks').val(),
                server: $('.servers').val(),
                body: $('#post_body').val(),
                is_main: is_main,
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
            },
            success: function (response) {
                console.log("Success");
            }
        })
    })

</script>
<script>
    var selected_gamer_profile;
    $('.gamer_profiles_dropdown-container').css('display', 'none');

    $(document).ready(function () {
        document.getElementById("gamer_profiles-btn").addEventListener("click", Toggle_Dropdown_Display);
    });

    $('.gamer_profiles_dropdown-btn').click(function () {
        selected_gamer_profile = $(this).text().trim();

        user_name = $('.sidebar_username').text().replaceAll(' ', '');
        $.ajax({
            type: 'POST',
            url: `/get_gamer_profile_stats/${user_name}`,
            dataType: "json",
            data: {
                game: selected_gamer_profile,
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
            },
            success: function (response) {

                $('.gamer_profile_stats_section').html(response['gamer_profile_stats']);
                Toggle_Dropdown_Display();
                console.log(response['game_logo'])
                $('.gamer_profiles-btn-value').text($('.game_name').text());
                $('.gamer_profiles-btn-img').attr("src", response['game_logo']);

            }
        })
    });


    function Toggle_Dropdown_Display() {
        if ($('.gamer_profiles_dropdown-container').css('display') == 'flex') {
            $('.gamer_profiles_dropdown-container').css('display', 'none');
        }
        else $('.gamer_profiles_dropdown-container').css('display', 'flex');
    }
</script>

{% endblock content %}